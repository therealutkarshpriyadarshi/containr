#!/bin/bash

# Containr Penetration Testing Script
# Tests for common container escape and security vulnerabilities

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONTAINR_BIN=${CONTAINR_BIN:-./bin/containr}
TEST_IMAGE=${TEST_IMAGE:-alpine}
RESULTS_FILE="pentest-results-$(date +%Y%m%d-%H%M%S).txt"

TESTS_RUN=0
VULNERABILITIES=0

echo -e "${BLUE}╔══════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║   Containr Penetration Testing Suite    ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════╝${NC}"
echo
echo "Results: $RESULTS_FILE"
echo

exec > >(tee -a "$RESULTS_FILE") 2>&1

test_vuln() {
    echo -e "\n${YELLOW}[TEST $((++TESTS_RUN))]${NC} $1"
}

vuln_found() {
    echo -e "${RED}  ✗ VULNERABLE:${NC} $1"
    ((VULNERABILITIES++))
}

not_vuln() {
    echo -e "${GREEN}  ✓ SECURE:${NC} $1"
}

needs_manual() {
    echo -e "${YELLOW}  ⚠ MANUAL CHECK:${NC} $1"
}

# Check root requirement
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}This script must be run as root${NC}"
    exit 1
fi

# 1. Namespace Escape Tests
echo -e "\n${BLUE}=== Namespace Escape Tests ===${NC}"

test_vuln "PID namespace escape via /proc"
# Try to access host processes
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" ls /proc/1/root 2>&1 | grep -q "Permission denied\|No such"; then
    not_vuln "Cannot access host PID 1"
else
    vuln_found "May be able to access host processes"
fi

test_vuln "Mount namespace escape"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" cat /proc/mounts 2>&1 | grep -q "/host\|/mnt/host"; then
    vuln_found "Host filesystem may be mounted"
else
    not_vuln "No obvious host mounts"
fi

# 2. Capability Tests
echo -e "\n${BLUE}=== Capability Tests ===${NC}"

test_vuln "CAP_SYS_ADMIN capability"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" mount -t tmpfs tmpfs /mnt 2>&1 | grep -q "Operation not permitted"; then
    not_vuln "CAP_SYS_ADMIN properly dropped"
else
    vuln_found "CAP_SYS_ADMIN may be available"
fi

test_vuln "CAP_NET_RAW capability"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" ping -c 1 127.0.0.1 2>&1 | grep -q "Operation not permitted\|ping: permission denied"; then
    not_vuln "CAP_NET_RAW properly dropped"
else
    needs_manual "CAP_NET_RAW may be available - verify if intentional"
fi

# 3. Filesystem Escape Tests
echo -e "\n${BLUE}=== Filesystem Escape Tests ===${NC}"

test_vuln "Directory traversal via symlinks"
needs_manual "Create symlink to /etc/passwd and check if accessible"

test_vuln "Writable cgroup mount"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" sh -c "echo test > /sys/fs/cgroup/test 2>&1" | grep -q "Permission denied\|Read-only"; then
    not_vuln "Cgroup filesystem not writable"
else
    vuln_found "Cgroup filesystem may be writable"
fi

# 4. Device Access Tests
echo -e "\n${BLUE}=== Device Access Tests ===${NC}"

test_vuln "Access to /dev/mem"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" ls -la /dev/mem 2>&1 | grep -q "No such file"; then
    not_vuln "/dev/mem not available"
else
    vuln_found "/dev/mem accessible - critical vulnerability"
fi

test_vuln "Access to /dev/kmem"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" ls -la /dev/kmem 2>&1 | grep -q "No such file"; then
    not_vuln "/dev/kmem not available"
else
    vuln_found "/dev/kmem accessible - critical vulnerability"
fi

# 5. Proc Filesystem Tests
echo -e "\n${BLUE}=== Proc Filesystem Tests ===${NC}"

test_vuln "Access to /proc/kcore"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" ls -la /proc/kcore 2>&1 | grep -q "Permission denied\|No such"; then
    not_vuln "/proc/kcore not accessible"
else
    vuln_found "/proc/kcore accessible"
fi

test_vuln "Kernel module loading"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" modprobe overlay 2>&1 | grep -q "not found\|Permission denied"; then
    not_vuln "Cannot load kernel modules"
else
    vuln_found "Kernel module loading may be possible"
fi

# 6. Seccomp Bypass Tests
echo -e "\n${BLUE}=== Seccomp Bypass Tests ===${NC}"

test_vuln "ptrace syscall"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" strace ls 2>&1 | grep -q "Operation not permitted\|strace: not found"; then
    not_vuln "ptrace blocked or strace not available"
else
    needs_manual "strace works - verify seccomp profile"
fi

# 7. Resource Limit Bypass
echo -e "\n${BLUE}=== Resource Limit Tests ===${NC}"

test_vuln "Memory limit bypass"
needs_manual "Attempt to allocate more memory than limit"

test_vuln "Fork bomb prevention"
if timeout 30s "$CONTAINR_BIN" run --pids 10 "$TEST_IMAGE" sh -c ':() { : | : & }; :' 2>&1 | grep -q "fork\|resource"; then
    not_vuln "Fork bomb prevented by PID limit"
else
    needs_manual "Fork bomb test inconclusive"
fi

# 8. Network Tests
echo -e "\n${BLUE}=== Network Security Tests ===${NC}"

test_vuln "Raw socket creation"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" sh -c "exec 3<>/dev/tcp/8.8.8.8/53" 2>&1 | grep -q "Network\|Permission"; then
    needs_manual "Network socket creation - verify isolation"
else
    needs_manual "Network test inconclusive"
fi

# 9. User Namespace Tests
echo -e "\n${BLUE}=== User Namespace Tests ===${NC}"

test_vuln "UID mapping check"
if timeout 10s "$CONTAINR_BIN" run "$TEST_IMAGE" id 2>&1 | grep -q "uid=0(root)"; then
    needs_manual "Running as root inside container - verify user namespace remapping"
else
    not_vuln "Not running as root"
fi

# 10. Docker Socket Access
echo -e "\n${BLUE}=== Docker Socket Escape ===${NC}"

test_vuln "Docker socket mount"
if timeout 10s "$CONTAINR_BIN" run -v /var/run/docker.sock:/var/run/docker.sock "$TEST_IMAGE" ls /var/run/docker.sock 2>&1 | grep -q "docker.sock"; then
    vuln_found "Docker socket can be mounted - CRITICAL if accessible"
else
    not_vuln "Docker socket mount blocked or not present"
fi

# Summary
echo -e "\n${BLUE}╔══════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║      Penetration Test Complete          ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════╝${NC}"
echo
echo "Tests Run: $TESTS_RUN"
echo -e "${RED}Vulnerabilities Found: $VULNERABILITIES${NC}"
echo
echo "Full results saved to: $RESULTS_FILE"

if [ $VULNERABILITIES -gt 0 ]; then
    echo -e "\n${RED}CRITICAL: Vulnerabilities detected!${NC}"
    echo "Please review and remediate immediately."
    exit 1
else
    echo -e "\n${GREEN}No critical vulnerabilities detected${NC}"
    echo "Note: Some tests require manual verification"
    exit 0
fi
