# Example Dockerfile for demonstrating containr build command
# This Dockerfile shows various instructions supported by containr

# Stage 1: Builder
FROM alpine:latest AS builder

# Set build arguments
ARG VERSION=1.0.0
ARG BUILD_DATE

# Set environment variables
ENV APP_HOME=/app \
    APP_PORT=8080

# Set working directory
WORKDIR ${APP_HOME}

# Install build dependencies
RUN apk add --no-cache \
    gcc \
    musl-dev \
    make

# Copy source code
COPY . .

# Build application
RUN echo "Building application version ${VERSION}"

# Stage 2: Runtime
FROM alpine:latest AS runtime

# Metadata labels
LABEL maintainer="containr@example.com" \
      version="${VERSION}" \
      description="Example application built with containr"

# Set environment
ENV APP_HOME=/app \
    APP_PORT=8080

# Create app user
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

# Set working directory
WORKDIR ${APP_HOME}

# Copy from builder stage
COPY --from=builder /app/bin/app .
COPY --from=builder /app/config ./config

# Change ownership
RUN chown -R appuser:appuser ${APP_HOME}

# Switch to non-root user
USER appuser

# Expose port
EXPOSE ${APP_PORT}

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:${APP_PORT}/health || exit 1

# Set volume
VOLUME ["/app/data"]

# Default command
CMD ["./app", "--port", "8080"]
